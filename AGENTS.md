# AGENTS.md

Guidelines for AI Agents and contributors. This document is the single, authoritative source for documentation and testing conventions in this repository.

## Purpose
- Unify documentation and testing behavior when code is generated or assisted by AI agents.
- Ensure rustdoc comments stay consistent and complete in this project.

## General Rules
- Write all documentation comments in English.
- Do not change existing logic solely to satisfy documentation; comments must describe current behavior.
- Keep examples minimal, correct, and preferably compilable as doctests.

## Documentation Comment Style (rustdoc)
Use the following structure and rules for rustdoc comments:
- First line: short Summary.
- Sections in this order when applicable:
    1. Parameters
    2. Returns
    3. Errors
    4. Panics
    5. Examples
    6. Notes
- Section headings: `# Parameters` style (hash + space + English heading).
- Bulleted lists: `- name: description`.
- For methods returning `Self`, explicitly note that a cloned instance is returned when applicable (e.g., "A cloned instance with the updated field(s).").

### Sample templates

Function/method returning `Self`:
```rust
/// Short summary.
///
/// # Parameters
/// - param_a: What this parameter means.
/// - param_b: Another description.
///
/// # Returns
/// A cloned instance with the updated field(s).
///
/// # Examples
/// ```rust
/// XXXXXXX
/// ```
///
/// # Notes
/// - Optional additional notes.
```

Function/method returning `Result<Self>`:
```rust
/// Short summary.
///
/// # Parameters
/// - path: Optional path to ...
///
/// # Returns
/// If successful, returns a cloned instance ...
///
/// # Errors
/// Returns an error if ...
///
/// # Examples
/// ```rust
/// XXXXXX
/// ```
```

Types (structs/enums):
```rust
/// Short, single-line summary.
///
/// # Fields
/// - field_a: Description.
/// - field_b: Description.
pub struct TypeName { /* ... */ }
```

## Repository-specific notes
- In examples, use real, existing paths and type names such as `use templatia::Template;`.
- If a method does not parse composite values like `host:port`, clarify this in `# Notes` and encourage using a dedicated setter for the port.
- For methods returning `Result<Self>`, document all possible error conditions in the `# Errors` section.

## Testing Policy
- When generating tests, implement tests to reflect the intent expressed in the documentation comments.
- Even if generated tests fail with the current implementation, do not modify the tests to fit the implementation if the tests correctly reflect the intended behavior described by the comments.
- Instead, surface the discrepancy and propose changes to the implementation or comments, but avoid changing tests merely to pass.

## Prohibition on Unrequested Source Edits (No Meddlesome behavior)
- Never edit source code when the explicit task is to write tests or documentation.
- Do not make unsolicited changes outside the requested scope. Provide a plan or suggestions to the user instead of executing out-of-scope edits.
- Examples:
  - Tests: Do not modify files under src/ or procedural macro code when only asked to create or adjust tests.
  - Docs: Do not modify implementation just to match documentation; propose changes and wait for approval.
- Rationale: Unrequested changes are risky and violate the principle of least surprise.
- Enforcement: Only perform changes explicitly requested in the issue. If a fix seems necessary, describe it and ask for confirmation before proceeding.

## Strict Prohibition on Destructive Git Commands
- **NEVER execute any git commands that discard or revert uncommitted changes.**
- **Absolutely forbidden commands include but are not limited to:**
  - `git checkout -- <path>` (discards uncommitted changes)
  - `git reset --hard` (discards uncommitted changes)
  - `git clean -f` or `git clean -fd` (deletes untracked files)
  - `git restore <path>` with options that discard changes
  - Any command that overwrites or deletes working directory changes
- **Rationale:** These commands permanently destroy uncommitted work and cannot be recovered. Such actions cause catastrophic data loss.
- **Safe alternatives:**
  - Use `git status` to check repository state
  - Use `git diff` to view changes
  - Use `git stash` to temporarily save changes (but ONLY if explicitly requested by the user)
  - Always ask the user before any operation that might affect uncommitted changes
- **Enforcement:** Executing any destructive git command is a critical violation. If you believe changes need to be reverted, describe the situation to the user and wait for explicit instructions.

## AI-Generated Code Attribution
- If a piece of code (function, method, struct, module, etc.) is generated by an AI agent, add a clear rustdoc attribution line in the item’s documentation comment:
    - Exactly: `This implementation is generated by XXXX(agent name)`
- Place this attribution as a separate paragraph within the rustdoc block, typically after the Summary and before other sections.

### Example (function returning Self)
```rust
/// Sets the mode.
///
/// This implementation is generated by ExampleAgent
///
/// # Parameters
/// - mode: Desired mode.
///
/// # Returns
/// A cloned instance with the updated mode.
///
/// # Examples
/// ```rust
/// XXXXXX
/// ```
```

### Example (function returning Result<Self>)
```rust
/// Loads configuration from an optional path.
///
/// This implementation is generated by ExampleAgent
///
/// # Parameters
/// - path: Optional file system path to a configuration file.
///
/// # Returns
/// If successful, returns a cloned instance with fields populated from the file.
///
/// # Errors
/// Returns an error if the file cannot be read or parsed.
///
/// # Examples
/// ```rust
/// XXXXXX
/// ```
```

## Prohibited Actions
- Do not alter tests to match an implementation when tests already align with the documented intent.
- Do not change public APIs or logic solely to satisfy or simplify documentation.

## Scope and Process
- For new features generated by an agent:
    - Include full rustdoc comments following this guide.
    - Add the attribution sentence as specified above.
    - Provide minimal, compilable doctests where feasible.
- For modifications to existing items:
    - Keep behavior unchanged unless a coordinated refactor is approved.
    - Update comments to maintain accuracy and consistency.

## Git Commit Messages
When generating git commit messages:
- **ALWAYS use a prefix** (feat, fix, docs, style, refactor, perf, test, chore)
- Keep the main message under 500 characters INCLUDING the prefix
- Use imperative mood after the prefix
- Be specific but concise
- No periods at the end
- Format: `prefix: message` and details should be written using bullet points.
- **Language**: Always use English for commit messages
- **Direction**: You are a senior developer. You never make oversights of the code changes. You need to check the all code changes and set commit message covering all the changes.

### Prefix Rules (Angular Convention):
- `feat:` A new feature
- `fix:` A bug fix
- `docs:` Documentation only changes
- `style:` Changes that do not affect the meaning of the code (formatting, missing semi-colons, etc)
- `refactor:` A code change that neither fixes a bug nor adds a feature
- `perf:` A code change that improves performance
- `test:` Adding missing or correcting existing tests
- `chore:` Changes to the build process or auxiliary tools and libraries

### Code Comments Language:
- **For international projects**: Use English comments
- **For domestic Japanese projects**: Use Japanese comments (コメントを日本語で記述した場合)
- Choose based on your team's preference and project requirements